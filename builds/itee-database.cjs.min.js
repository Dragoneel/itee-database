"use strict";function isNotNull(r){return null!==r}function isNullOrUndefined(r){return null===r||void 0===r}function isDefined(r){return null!==r&&void 0!==r}function isEmpty(r){if(null===r)return!0;if(void 0===r)return!0;if(r.length>0)return!1;if(0===r.length)return!0;for(let t in r)if(Object.prototype.hasOwnProperty.call(r,t))return!1;return!0}function isNotEmpty(r){return!isEmpty(r)}function isObject(r){return isNotNull(r)&&"object"==typeof r&&!Array.isArray(r)}function isNotEmptyObject(r){return isObject(r)&&isNotEmpty(r)}function isArray(r){return Array.isArray(r)}function isNotEmptyArray(r){return isArray(r)&&isNotEmpty(r)}function _isString(r){return"string"==typeof r||r instanceof String}function _isNullOrEmptyArray(r){return!r||r.constructor===Array&&0===r.length}function _isArray(r){return r.constructor===Array}function _isObject(r){return r===Object(r)}function _normalizeError(r){var t=[];if(_isArray(r))for(var e=0,n=r.length;e<n;++e)t=t.concat(_normalizeError(r[e]));else if(_isObject(r))if("ValidationError"===r.name){var o="",i=r.errors;for(var u in i)i.hasOwnProperty(u)&&(o+=i[u].message+"<br>");t.push({title:"Erreur de validation",message:o||"Aucun message d'erreur... Gloups !"})}else"VersionError"===r.name?t.push({title:"Erreur de base de donnée",message:"Aucun document correspondant n'as put être trouvé pour la requete !"}):t.push({title:r.title||"Erreur",message:r.message||"Aucun message d'erreur... Gloups !"});else{if(!_isString(r))throw new Error("Unknown error type: "+r+', please report your issue at "https://github.com/TristanVALCKE/i-return/issues"');t.push({title:"Erreur",message:r})}return t}function returnNotFound(r){return"function"==typeof r?r():r.headersSent?void 0:r.status(204).end()}function returnError(r,t){return"function"==typeof t?t(r,null):t.headersSent?void 0:t.status(500).end(JSON.stringify(r))}function returnData(r,t){return"function"==typeof t?t(null,r):t.headersSent?void 0:t.status(200).end(JSON.stringify(r))}function returnErrorAndData(r,t,e){return"function"==typeof e?e(r,t):e.headersSent?void 0:e.status(406).end(JSON.stringify({errors:r,data:t}))}function returnResponse(r,t){function e(t,e){a.beforeReturnErrorAndData&&a.beforeReturnErrorAndData(t,e),a.returnErrorAndData&&a.returnErrorAndData(t,e,r),a.afterReturnErrorAndData&&a.afterReturnErrorAndData(t,e)}function n(t){a.beforeReturnError&&a.beforeReturnError(t),a.returnError&&a.returnError(t,r),a.afterReturnError&&a.afterReturnError(t)}function o(t){a.beforeReturnData&&a.beforeReturnData(t),a.returnData&&a.returnData(t,r),a.afterReturnData&&a.afterReturnData(t)}function i(){a.beforeReturnNotFound&&a.beforeReturnNotFound(),a.returnNotFound&&a.returnNotFound(r),a.afterReturnNotFound&&a.afterReturnNotFound()}function u(r,t){if(a.beforeAll&&a.beforeAll(),a.returnForAll)a.returnForAll(r,t);else if(_isNullOrEmptyArray(r))_isNullOrEmptyArray(t)?i():o(t);else{var u=_normalizeError(r);_isNullOrEmptyArray(t)?n(u):e(u,t)}a.afterAll&&a.afterAll()}var s=t||{},a={beforeAll:null,returnForAll:null,afterAll:null,beforeReturnErrorAndData:null,returnErrorAndData:returnErrorAndData,afterReturnErrorAndData:null,beforeReturnError:null,returnError:returnError,afterReturnError:null,beforeReturnData:null,returnData:returnData,afterReturnData:null,beforeReturnNotFound:null,returnNotFound:returnNotFound,afterReturnNotFound:null};for(var f in s)s.hasOwnProperty(f)&&a.hasOwnProperty(f)&&(a[f]=s[f]);return u}function TAbstractFileConverter(){this.dumpType="arraybuffer",this._isProcessing=!1,this._filesQueue=[],this._fileData=void 0}Object.defineProperty(exports,"__esModule",{value:!0});class TAbstractDatabase{constructor(r,t,e,n=[],o=1e4){this.routes={},this._driver=r,this._application=t,this._router=e,this._plugins=n,this._autoReconnectTimeout=o,this._autoConnectionTimer=null,this.__init()}__init(){const r=this._plugins;for(let t=0,e=r.length;t<e;t++){const e=r[t];let n=void 0;try{n=require(e)}catch(r){continue}n.registerTo(this._driver,this._application,this._router)}this._init()}_init(){}connect(){}startAutoConnect(){this._autoConnectionTimer||(this._autoConnectionTimer=setInterval(this.connect.bind(this),this._autoReconnectTimeout))}stopAutoConnect(){this._autoConnectionTimer&&(clearInterval(this._autoConnectionTimer),this._autoConnectionTimer=null)}close(r){}on(r,t){}}class TAbstractDatabasePlugin{constructor(r){this.routes={}}registerTo(r){}addRoutesTo(r){let t=r;for(let r in this.routes)t[r]||(t[r]=this.routes[r]);return t}}var iReturn={return:returnResponse,returnError:returnError,returnNotFound:returnNotFound,returnData:returnData,returnErrorAndData:returnErrorAndData};class TAbstractDataController{constructor(r){this._parameters=r}static __checkData(r,t,e){const n=t.body,o=t.params,i=t.query;return isDefined(n)&&n[r]?n[r]:isDefined(o)&&o[r]?o[r]:isDefined(i)&&i[r]?i[r]:void iReturn.returnError({title:"Erreur de paramètre",message:r+" n'existe pas dans les paramètres !"},e)}create(r,t){const e=r.body;if(isNullOrUndefined(e))return void iReturn.returnError({title:"Erreur de paramètre",message:"Aucun paramètre n'a été reçu !"},t);isArray(e)?this._createSome(e,t):this._createOne(e,t)}_createOne(r,t){}_createSome(r,t){}read(r,t){const e=r.body,n=r.params.id;t.set("Content-Type","application/json"),isDefined(e)?isNotEmptyObject(e)?this._readByObject(e,t):isNotEmptyArray(e)?this._readByArray(e,t):iReturn.returnError({title:"Erreur de paramètre",message:"La requête ne contient pas de données !"},t):isDefined(n)?this._readById(n,t):this._readAll(t)}_readById(r,t){}_readByArray(r,t){}_readByObject(r,t){}_readAll(r){}update(r,t){const e=r.body,n=r.params.id;isDefined(e)?isNotEmptyObject(e)?this._updateByObject(e,t):isNotEmptyArray(e)?this._updateByArray(e,t):iReturn.returnError({title:"Erreur de paramètre",message:"La requête ne contient pas de données !"},t):isDefined(n)?this._updateById(n,t):this._updateAll(t)}_updateById(r,t){}_updateByArray(r,t){}_updateByObject(r,t){}_updateAll(r){}delete(r,t){const e=r.body,n=r.params.id;isDefined(e)?isNotEmptyObject(e)?this._deleteByObject(e,t):isNotEmptyArray(e)?this._deleteByArray(e,t):iReturn.returnError({title:"Erreur de paramètre",message:"La requête ne contient pas de données !"},t):isDefined(n)?this._deleteById(n,t):this._deleteAll(t)}_deleteById(r,t){}_deleteByArray(r,t){}_deleteByObject(r,t){}_deleteAll(r){}}const fs=require("fs"),{Writable:Writable}=require("stream"),globalBuffer=require("buffer");class MemoryWriteStream extends Writable{constructor(r){super(r);const t=r.bufferSize||globalBuffer.kStringMaxLength;this.memoryBuffer=Buffer.alloc(t),this.offset=0}_write(r,t,e){const n=Buffer.isBuffer(r)?r:new Buffer(r,t);for(let r=0,t=n.length;r<t;r++)this.memoryBuffer[this.offset]=n[r],this.offset++;e()}_writev(r,t){for(let t=0,e=r.length;t<e;t++)this.memoryBuffer=Buffer.concat([this.memoryBuffer,r[t]]);t()}_final(r){r()}_releaseMemory(){this.memoryBuffer=null}toArrayBuffer(){const r=this.memoryBuffer,t=new ArrayBuffer(r.length),e=new Uint8Array(t);for(let t=0;t<r.length;++t)e[t]=r[t];return this._releaseMemory(),t}toString(){const r=this.memoryBuffer.toString();return this._releaseMemory(),r}toJSON(){return JSON.parse(this.toString())}}TAbstractFileConverter.MAX_FILE_SIZE=67108864,TAbstractFileConverter.prototype.convert=function(r,t,e,n,o){this._filesQueue.push({file:r,parameters:t,onSuccess:e,onProgress:n,onError:o}),this._isProcessing||this._processQueue()},TAbstractFileConverter.prototype._processQueue=function(){function r(r){o._fileData=r,o._convert(s,t,e,n)}function t(r){o._releaseMemory(),a(r),o._processQueue()}function e(r){f(r)}function n(r){c(r),o._processQueue()}if(0===this._filesQueue.length)return void(this._isProcessing=!1);this._isProcessing=!0;const o=this,i=this._filesQueue.shift(),u=i.file,s=i.parameters,a=i.onSuccess,f=i.onProgress,c=i.onError;o._dumpFileInMemoryAs(this.dumpType,u,s,r,e,n)},TAbstractFileConverter.prototype._dumpFileInMemoryAs=function(r,t,e,n,o,i){let u=!1;const s=fs.createReadStream(t);s.on("error",r=>{u=!0;i(r)});const a=parseInt(e.fileSize),f=new MemoryWriteStream({bufferSize:a});f.on("error",r=>{u=!0;i(r)}),f.on("finish",()=>{if(u)return;switch(r){case"arraybuffer":n(f.toArrayBuffer());break;case"string":n(f.toString());break;case"json":n(f.toJSON());break;default:throw new RangeError(`Invalid switch parameter: ${r}`)}s.unpipe();s.close();f.end()}),s.pipe(f)},TAbstractFileConverter.prototype._releaseMemory=function(){this._fileData=null},TAbstractFileConverter.prototype._convert=function(r,t,e,n){},module.exports=TAbstractFileConverter,exports.TAbstractDatabase=TAbstractDatabase,exports.TAbstractDatabasePlugin=TAbstractDatabasePlugin,exports.TAbstractDataController=TAbstractDataController;
