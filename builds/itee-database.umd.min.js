!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((r.Itee=r.Itee||{},r.Itee.Database={}))}(this,function(r){"use strict";function e(r){return null!==r}function t(r){return null===r||void 0===r}function n(r){return null!==r&&void 0!==r}function o(r){if(null===r)return!0;if(void 0===r)return!0;if(r.length>0)return!1;if(0===r.length)return!0;for(let e in r)if(Object.prototype.hasOwnProperty.call(r,e))return!1;return!0}function u(r){return!o(r)}function i(r){return e(r)&&"object"==typeof r&&!Array.isArray(r)}function s(r){return i(r)&&u(r)}function a(r){return Array.isArray(r)}function f(r){return a(r)&&u(r)}function c(r){return"string"==typeof r||r instanceof String}function l(r){return!r||r.constructor===Array&&0===r.length}function d(r){return r.constructor===Array}function h(r){return r===Object(r)}function p(r){var e=[];if(d(r))for(var t=0,n=r.length;t<n;++t)e=e.concat(p(r[t]));else if(h(r))if("ValidationError"===r.name){var o="",u=r.errors;for(var i in u)u.hasOwnProperty(i)&&(o+=u[i].message+"<br>");e.push({title:"Erreur de validation",message:o||"Aucun message d'erreur... Gloups !"})}else"VersionError"===r.name?e.push({title:"Erreur de base de donnée",message:"Aucun document correspondant n'as put être trouvé pour la requete !"}):e.push({title:r.title||"Erreur",message:r.message||"Aucun message d'erreur... Gloups !"});else{if(!c(r))throw new Error("Unknown error type: "+r+', please report your issue at "https://github.com/TristanVALCKE/i-return/issues"');e.push({title:"Erreur",message:r})}return e}function y(r){return"function"==typeof r?r():r.headersSent?void 0:r.status(204).end()}function m(r,e){return"function"==typeof e?e(r,null):e.headersSent?void 0:e.status(500).end(JSON.stringify(r))}function _(r,e){return"function"==typeof e?e(null,r):e.headersSent?void 0:e.status(200).end(JSON.stringify(r))}function b(r,e,t){return"function"==typeof t?t(r,e):t.headersSent?void 0:t.status(406).end(JSON.stringify({errors:r,data:e}))}function g(r,e){function t(e,t){a.beforeReturnErrorAndData&&a.beforeReturnErrorAndData(e,t),a.returnErrorAndData&&a.returnErrorAndData(e,t,r),a.afterReturnErrorAndData&&a.afterReturnErrorAndData(e,t)}function n(e){a.beforeReturnError&&a.beforeReturnError(e),a.returnError&&a.returnError(e,r),a.afterReturnError&&a.afterReturnError(e)}function o(e){a.beforeReturnData&&a.beforeReturnData(e),a.returnData&&a.returnData(e,r),a.afterReturnData&&a.afterReturnData(e)}function u(){a.beforeReturnNotFound&&a.beforeReturnNotFound(),a.returnNotFound&&a.returnNotFound(r),a.afterReturnNotFound&&a.afterReturnNotFound()}function i(r,e){if(a.beforeAll&&a.beforeAll(),a.returnForAll)a.returnForAll(r,e);else if(l(r))l(e)?u():o(e);else{var i=p(r);l(e)?n(i):t(i,e)}a.afterAll&&a.afterAll()}var s=e||{},a={beforeAll:null,returnForAll:null,afterAll:null,beforeReturnErrorAndData:null,returnErrorAndData:b,afterReturnErrorAndData:null,beforeReturnError:null,returnError:m,afterReturnError:null,beforeReturnData:null,returnData:_,afterReturnData:null,beforeReturnNotFound:null,returnNotFound:y,afterReturnNotFound:null};for(var f in s)s.hasOwnProperty(f)&&a.hasOwnProperty(f)&&(a[f]=s[f]);return i}function A(){this.dumpType="arraybuffer",this._isProcessing=!1,this._filesQueue=[],this._fileData=void 0}class E{constructor(r,e,t,n=[],o=1e4){this.routes={},this._driver=r,this._application=e,this._router=t,this._plugins=n,this._autoReconnectTimeout=o,this._autoConnectionTimer=null,this.__init()}__init(){const r=this._plugins;for(let e=0,t=r.length;e<t;e++){const t=r[e];let n=void 0;try{n=require(t)}catch(r){continue}n.registerTo(this._driver,this._application,this._router)}this._init()}_init(){}connect(){}startAutoConnect(){this._autoConnectionTimer||(this._autoConnectionTimer=setInterval(this.connect.bind(this),this._autoReconnectTimeout))}stopAutoConnect(){this._autoConnectionTimer&&(clearInterval(this._autoConnectionTimer),this._autoConnectionTimer=null)}close(r){}on(r,e){}}class v{constructor(r){this.routes={}}registerTo(r){}addRoutesTo(r){let e=r;for(let r in this.routes)e[r]||(e[r]=this.routes[r]);return e}}var R={return:g,returnError:m,returnNotFound:y,returnData:_,returnErrorAndData:b};class D{constructor(r){this._parameters=r}static __checkData(r,e,t){const o=e.body,u=e.params,i=e.query;return n(o)&&o[r]?o[r]:n(u)&&u[r]?u[r]:n(i)&&i[r]?i[r]:void R.returnError({title:"Erreur de paramètre",message:r+" n'existe pas dans les paramètres !"},t)}create(r,e){const n=r.body;if(t(n))return void R.returnError({title:"Erreur de paramètre",message:"Aucun paramètre n'a été reçu !"},e);a(n)?this._createSome(n,e):this._createOne(n,e)}_createOne(r,e){}_createSome(r,e){}read(r,e){const t=r.body,o=r.params.id;e.set("Content-Type","application/json"),n(t)?s(t)?this._readByObject(t,e):f(t)?this._readByArray(t,e):R.returnError({title:"Erreur de paramètre",message:"La requête ne contient pas de données !"},e):n(o)?this._readById(o,e):this._readAll(e)}_readById(r,e){}_readByArray(r,e){}_readByObject(r,e){}_readAll(r){}update(r,e){const t=r.body,o=r.params.id;n(t)?s(t)?this._updateByObject(t,e):f(t)?this._updateByArray(t,e):R.returnError({title:"Erreur de paramètre",message:"La requête ne contient pas de données !"},e):n(o)?this._updateById(o,e):this._updateAll(e)}_updateById(r,e){}_updateByArray(r,e){}_updateByObject(r,e){}_updateAll(r){}delete(r,e){const t=r.body,o=r.params.id;n(t)?s(t)?this._deleteByObject(t,e):f(t)?this._deleteByArray(t,e):R.returnError({title:"Erreur de paramètre",message:"La requête ne contient pas de données !"},e):n(o)?this._deleteById(o,e):this._deleteAll(e)}_deleteById(r,e){}_deleteByArray(r,e){}_deleteByObject(r,e){}_deleteAll(r){}}const B=require("fs"),{Writable:Writable}=require("stream"),S=require("buffer");class F extends Writable{constructor(r){super(r);const e=r.bufferSize||S.kStringMaxLength;this.memoryBuffer=Buffer.alloc(e),this.offset=0}_write(r,e,t){const n=Buffer.isBuffer(r)?r:new Buffer(r,e);for(let r=0,e=n.length;r<e;r++)this.memoryBuffer[this.offset]=n[r],this.offset++;t()}_writev(r,e){for(let e=0,t=r.length;e<t;e++)this.memoryBuffer=Buffer.concat([this.memoryBuffer,r[e]]);e()}_final(r){r()}_releaseMemory(){this.memoryBuffer=null}toArrayBuffer(){const r=this.memoryBuffer,e=new ArrayBuffer(r.length),t=new Uint8Array(e);for(let e=0;e<r.length;++e)t[e]=r[e];return this._releaseMemory(),e}toString(){const r=this.memoryBuffer.toString();return this._releaseMemory(),r}toJSON(){return JSON.parse(this.toString())}}A.MAX_FILE_SIZE=67108864,A.prototype.convert=function(r,e,t,n,o){this._filesQueue.push({file:r,parameters:e,onSuccess:t,onProgress:n,onError:o}),this._isProcessing||this._processQueue()},A.prototype._processQueue=function(){function r(r){o._fileData=r,o._convert(s,e,t,n)}function e(r){o._releaseMemory(),a(r),o._processQueue()}function t(r){f(r)}function n(r){c(r),o._processQueue()}if(0===this._filesQueue.length)return void(this._isProcessing=!1);this._isProcessing=!0;const o=this,u=this._filesQueue.shift(),i=u.file,s=u.parameters,a=u.onSuccess,f=u.onProgress,c=u.onError;o._dumpFileInMemoryAs(this.dumpType,i,s,r,t,n)},A.prototype._dumpFileInMemoryAs=function(r,e,t,n,o,u){let i=!1;const s=B.createReadStream(e);s.on("error",r=>{i=!0;u(r)});const a=parseInt(t.fileSize),f=new F({bufferSize:a});f.on("error",r=>{i=!0;u(r)}),f.on("finish",()=>{if(i)return;switch(r){case"arraybuffer":n(f.toArrayBuffer());break;case"string":n(f.toString());break;case"json":n(f.toJSON());break;default:throw new RangeError(`Invalid switch parameter: ${r}`)}s.unpipe();s.close();f.end()}),s.pipe(f)},A.prototype._releaseMemory=function(){this._fileData=null},A.prototype._convert=function(r,e,t,n){},module.exports=A,r.TAbstractDatabase=E,r.TAbstractDatabasePlugin=v,r.TAbstractDataController=D,Object.defineProperty(r,"__esModule",{value:!0})});
